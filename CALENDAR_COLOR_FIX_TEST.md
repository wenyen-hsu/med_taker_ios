# 🔧 日曆顏色標記修復 - 測試指南

## 問題診斷結果

### ❌ 原始問題
**症狀**: 新增排程後，日曆視圖中沒有顯示顏色標記點

**根本原因**:
1. `CalendarViewModel` 只載入已存在的記錄，不會自動從排程生成記錄
2. `MedicationScheduleViewModel` 新增排程時，只保存排程本身，沒有生成每日記錄
3. 結果：只有當用戶進入每日視圖時，該日的記錄才會被生成

### ✅ 修復方案

#### **修復 1: CalendarViewModel.swift**
**位置**: 第 22-89 行

**新增功能**:
```swift
// 載入月份時，為每一天自動生成記錄（如果不存在）
private func generateMonthRecords(from:to:schedules:)
```

**修復效果**:
- 載入任何月份時，自動檢查每一天
- 如果某天沒有記錄，從排程自動生成
- 確保日曆上所有有排程的日期都有顏色點

#### **修復 2: MedicationScheduleViewModel.swift**
**位置**: 第 44-95 行

**新增功能**:
```swift
// 新增排程時，立即生成未來 60 天的記錄
private func generateRecordsForSchedule(_ schedule:)
```

**修復效果**:
- 新增排程的瞬間，生成未來 60 天的記錄
- 立即在日曆上顯示顏色標記
- 無需等待用戶進入每日視圖

---

## 🧪 快速測試步驟

### 測試 1: 新增排程後立即顯示 ✓

**步驟**:
1. 清理並重新建置 App
2. 開啟 App，確保目前沒有任何排程
3. 切換到「排程」頁面
4. 點擊「+」新增排程：
   - 藥物名稱：測試藥 A
   - 劑量：1 顆
   - 時間：11:00 PM（或任何時間）
   - 頻率：每日
   - 開始日期：今天
5. 儲存排程
6. **立即**切換到「日曆」頁面

**預期結果**:
```
✓ 今天的日期格子下方顯示「紅色」小圓點
  （因為還沒服用，total > 0 但 completed = 0）

✓ 未來幾天（明天、後天等）也都有「紅色」小圓點
  （已生成未來 60 天的記錄）

✓ 狀態說明卡片清楚顯示在日曆下方
```

---

### 測試 2: 標記服用後顏色變化 ✓

**步驟**:
1. 從測試 1 繼續
2. 點擊今天的日期，進入每日詳細視圖
3. 找到「測試藥 A」
4. 點擊「✓ 標記為已服用」
5. 選擇當前時間（例如 11:05 PM，在 11:00 PM 之後 15 分鐘內）
6. 確認
7. 返回日曆視圖

**預期結果**:
```
✓ 今天的顏色從紅色變為綠色
  （因為全部準時完成）

✓ 明天和未來的日期仍是紅色
  （還沒到服用時間）
```

---

### 測試 3: 遲到服用的黃色標記 ✓

**步驟**:
1. 等到明天，或手動調整系統時間到明天
2. 進入明天的每日視圖
3. 將「測試藥 A」標記為已服用
4. 選擇一個遲到的時間（例如預定 11:00 PM，實際 11:30 PM）
5. 返回日曆

**預期結果**:
```
✓ 明天的顏色顯示為黃色
  （全部完成但有遲到）
```

---

### 測試 4: 部分完成的橙色標記 ✓

**步驟**:
1. 新增第二個排程：
   - 藥物名稱：測試藥 B
   - 時間：8:00 AM
   - 頻率：每日
   - 開始日期：今天
2. 進入今天的每日視圖
3. 只標記「測試藥 A」為已服用
4. 不要標記「測試藥 B」
5. 返回日曆

**預期結果**:
```
✓ 今天的顏色顯示為橙色
  （部分完成：1/2）
```

---

### 測試 5: 切換月份仍正常 ✓

**步驟**:
1. 在日曆視圖中
2. 點擊「>」切換到下個月
3. 觀察顏色標記
4. 點擊「<」切換回這個月
5. 再次觀察顏色標記

**預期結果**:
```
✓ 下個月的日期也有顏色標記（紅色，因為未服用）

✓ 切換回來時，這個月的顏色正確
  （今天橙色、明天黃色等）

✓ 沒有延遲或閃爍
```

---

### 測試 6: 深色模式檢查 ✓

**步驟**:
1. 在 iOS 設定中切換到深色模式
2. 返回 App
3. 查看日曆視圖

**預期結果**:
```
✓ 所有顏色仍清晰可見
  綠、黃、橙、紅色在深色背景下對比度足夠

✓ 狀態說明卡片背景變為深色

✓ 文字易讀
```

---

### 測試 7: 週頻率排程 ✓

**步驟**:
1. 新增週頻率排程：
   - 藥物名稱：週測試藥
   - 時間：9:00 AM
   - 頻率：每週
   - 活動日：選擇「週一」和「週三」
   - 開始日期：本週一
2. 切換到日曆視圖

**預期結果**:
```
✓ 只有週一和週三的日期有顏色點

✓ 其他日期（週二、四、五、六、日）沒有點

✓ 未來幾週的週一、週三也都有點
```

---

## ✅ 通過標準

所有以下測試都必須通過：

```
□ 測試 1: 新增排程立即顯示
□ 測試 2: 標記服用後顏色變化
□ 測試 3: 遲到服用黃色標記
□ 測試 4: 部分完成橙色標記
□ 測試 5: 切換月份正常
□ 測試 6: 深色模式正常
□ 測試 7: 週頻率排程正確
```

---

## 🐛 如果仍然沒有顏色點

### 檢查清單

**1. 確認已重新建置**
```
Product → Clean Build Folder (⇧⌘K)
Product → Build (⌘B)
```

**2. 檢查排程是否啟用**
```
在排程列表中，確認排程的開關是「綠色」（啟用狀態）
```

**3. 檢查日期範圍**
```
確認查看的日期在排程的開始日期之後
如果有結束日期，確認在結束日期之前
```

**4. 檢查 Console 輸出**
```
查看 Xcode Console 是否有錯誤訊息
搜尋關鍵字：「generateMonthRecords」或「generateRecordsForSchedule」
```

**5. 強制重新載入**
```
嘗試以下操作：
a) 切換到其他頁面再切回日曆
b) 切換月份後再切回來
c) 完全關閉 App 後重新開啟
```

---

## 📝 測試記錄

**測試日期**: ___________
**測試人員**: ___________
**設備/模擬器**: ___________

**通過的測試**: _____ / 7

**發現的問題**:
```
問題描述：

重現步驟：

截圖：
```

**總體評價**: □ 通過 ✓  □ 需要進一步修正
